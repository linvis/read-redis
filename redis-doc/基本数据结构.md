## sds

这里关注几个重点API，创建、扩容、释放

### sds

sds是string存储的基本单元

在C语言中，string是以`\0`结尾，对于本身就包含`\0`的string来说，会被C语言意外截断，为了解决这个问题，redis采用了保存string长度的方法

redis按照string的长度，划分了5类数据，分别表征$2^5, 2^8, 2^16, 2^32, 2^{64}$的长度

```c
#define SDS_TYPE_5  0
#define SDS_TYPE_8  1
#define SDS_TYPE_16 2
#define SDS_TYPE_32 3
#define SDS_TYPE_64 4
```

第二，每种sds，有三个头部信息(SDS_TYPE_5有两个)，分别是总长度，已使用的长度，字符串类型

```c
/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

> 每个结构体都是packed的，可以很方便的根据buf，获取到len、alloc、flags等字段
>
> buf地址返回给上层api，完美的兼容C

### sdsnewlen

```c
sds sdsnewlen(const void *init, size_t initlen)
```

* 根据initlen，设置成不同的type

* 创建并初始化sdshdr结构体
* malloc和memcpy字符串

> 这里，len和alloc都被初始化成initlen，即new的时候，不存在free的数据

### sdscatlen

```c
sds sdscatlen(sds s, const void *t, size_t len)
```

本质即扩容

* 判断free len是否满足
* 不满足则扩容，新长度小于1M，直接2倍扩容，大于1M，+1M扩容
* 判断扩容后type是否变化，无变化realloc申请，否则malloc
* 扩容完，拷贝拼接，更新sdshdr结构体

### sdsfree

```c
void sdsfree(sds s)
```

很简单，通过s找到sdshdr结构体的指针，代用zfree释放

### 总结

整个sds的操作都比较简单，在C的string之上，包装了一层

